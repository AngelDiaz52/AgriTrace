<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Farm Manager</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
  <style>
    body, html {
      margin: 0;
      height: 100%;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    }

    #container {
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    #sidebar {
      width: 320px;
      transition: all 0.3s ease;
      background: #fff;
      border-right: 1px solid #ccc;
      padding: 15px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      position: relative;
      z-index: 1000;
      resize: horizontal;
      min-width: 200px;
      max-width: 500px;
    }

    #sidebar.collapsed {
      width: 0 !important;
      padding: 0;
      overflow: hidden;
    }

    #toggle-sidebar {
      position: absolute;
      top: 10px;
      right: -20px;
      width: 20px;
      height: 40px;
      background: #ccc;
      border: 1px solid #999;
      border-left: none;
      border-radius: 0 4px 4px 0;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 1001;
    }

    #toggle-sidebar span {
      font-size: 18px;
      color: #000;
    }

    #map {
      flex-grow: 1;
    }

    input, button {
      margin: 5px 0;
      padding: 8px;
      font-size: 1rem;
      width: 100%;
      box-sizing: border-box;
    }

    .farm-list {
      margin-top: 10px;
    }

    .farm-item {
      cursor: pointer;
      padding: 5px;
      border-bottom: 1px solid #eee;
    }

    .field-label {
      background: rgba(255,255,255,0.7);
      padding: 2px 4px;
      border-radius: 3px;
      font-size: 0.8rem;
    }

    .todo-list {
      margin-top: 10px;
    }

    .todo-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 5px 0;
    }

    .todo-item span {
      flex-grow: 1;
      cursor: pointer;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .field-buttons {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div id="container">
    <div id="sidebar">
      <div id="toggle-sidebar"><span>&#9664;</span></div>
      <h2>Farm Manager</h2>
      <input id="farmName" placeholder="Farm Name" />
      <input id="zipInput" placeholder="ZIP or Address" />
      <button onclick="addFarm()">Add Farm</button>

      <div class="farm-list" id="farmList"></div>

      <div class="tab-content" id="fieldInfo">
        <h3 id="fieldLabelTitle"></h3>
        <input id="taskInput" placeholder="Add task..." />
        <button onclick="addTask()">Add Task</button>
        <div id="todoList" class="todo-list"></div>
        <div class="field-buttons">
          <button onclick="toggleFieldInfo()">Hide</button>
          <button onclick="deleteField()">Delete Field</button>
        </div>
      </div>
    </div>
    <div id="map"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
  <script>
    const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: 'Tiles © Esri'
    });

    const streets = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    });

    let map = L.map('map', {
      center: [47.6062, -122.3321],
      zoom: 10,
      layers: [satellite]
    });

    const baseLayers = {
      "Satellite (Esri)": satellite,
      "Streets (OSM)": streets
    };
    L.control.layers(baseLayers).addTo(map);

    const toggleBtn = document.getElementById('toggle-sidebar');
    const sidebar = document.getElementById('sidebar');
    const arrow = toggleBtn.querySelector('span');
    toggleBtn.onclick = () => {
      sidebar.classList.toggle('collapsed');
      arrow.innerHTML = sidebar.classList.contains('collapsed') ? '&#9654;' : '&#9664;';
    };

    let farms = JSON.parse(localStorage.getItem('farms') || '[]');
    const saveFarms = () => localStorage.setItem('farms', JSON.stringify(farms));

    function addFarm() {
      const name = document.getElementById("farmName").value.trim();
      const zip = document.getElementById("zipInput").value.trim();
      if (!name || !zip) return;

      fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(zip)}`)
        .then(res => res.json())
        .then(data => {
          if (data && data[0]) {
            const { lat, lon } = data[0];
            const farm = { name, zip, lat, lon };
            farms.push(farm);
            saveFarms();
            renderFarmList();
            map.setView([lat, lon], 14);
          }
        });

      document.getElementById("farmName").value = "";
      document.getElementById("zipInput").value = "";
    }

    function renderFarmList() {
      const list = document.getElementById("farmList");
      list.innerHTML = '';
      farms.forEach((farm) => {
        const item = document.createElement("div");
        item.className = "farm-item";
        item.textContent = `${farm.name} (${farm.zip})`;
        item.onclick = () => map.setView([farm.lat, farm.lon], 14);
        list.appendChild(item);
      });
    }

    const drawnItems = new L.FeatureGroup().addTo(map);
    const drawControl = new L.Control.Draw({
      edit: { featureGroup: drawnItems },
      draw: { polygon: true, rectangle: true, circle: false, marker: false, polyline: false }
    });
    map.addControl(drawControl);

    let selectedField = null;

    map.on(L.Draw.Event.CREATED, function (event) {
      const layer = event.layer;
      const label = prompt("Enter field label:");
      if (label) {
        layer.bindTooltip(label, { permanent: true, direction: "center", className: "field-label" });
        layer.fieldLabel = label;
        layer.tasks = [];
        drawnItems.addLayer(layer);
      }
    });

    map.on("click", () => {
      document.querySelectorAll(".tab-content").forEach(tab => tab.classList.remove("active"));
      selectedField = null;
    });

    drawnItems.on("click", function (e) {
      selectedField = e.layer;
      showFieldInfo();
    });

    function showFieldInfo() {
      if (!selectedField) return;
      document.querySelectorAll(".tab-content").forEach(tab => tab.classList.remove("active"));
      document.getElementById("fieldLabelTitle").textContent = selectedField.fieldLabel;
      document.getElementById("todoList").innerHTML = "";

      selectedField.tasks.forEach((task, i) => {
        const item = document.createElement("div");
        item.className = "todo-item";
        item.innerHTML = `
          <input type="checkbox" ${task.done ? "checked" : ""} onchange="toggleTask(${i})">
          <span onclick="editTask(${i})">${task.text}</span>
          <button onclick="removeTask(${i})">✕</button>`;
        document.getElementById("todoList").appendChild(item);
      });

      document.getElementById("fieldInfo").classList.add("active");
    }

    function addTask() {
      if (!selectedField) return;
      const text = document.getElementById("taskInput").value.trim();
      if (!text) return;
      selectedField.tasks.push({ text, done: false });
      document.getElementById("taskInput").value = "";
      showFieldInfo();
    }

    function toggleTask(index) {
      if (selectedField) {
        selectedField.tasks[index].done = !selectedField.tasks[index].done;
      }
    }

    function removeTask(index) {
      if (selectedField) {
        selectedField.tasks.splice(index, 1);
        showFieldInfo();
      }
    }

    function editTask(index) {
      if (!selectedField) return;
      const current = selectedField.tasks[index].text;
      const updated = prompt("Edit task:", current);
      if (updated !== null) {
        selectedField.tasks[index].text = updated.trim();
        showFieldInfo();
      }
    }

    function deleteField() {
      if (selectedField && confirm("Delete this field?")) {
        drawnItems.removeLayer(selectedField);
        selectedField = null;
        document.getElementById("fieldInfo").classList.remove("active");
      }
    }

    function toggleFieldInfo() {
      document.getElementById("fieldInfo").classList.remove("active");
      selectedField = null;
    }

    renderFarmList();
  </script>
</body>
</html>
