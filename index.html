<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Agri Trace</title>
  <link href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" rel="stylesheet" />
  <link href="https://api.tiles.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet" />
  <link href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" rel="stylesheet" />
  <style>
    html, body {
      margin: 0;
      height: 100%;
      font-family: "Segoe UI", sans-serif;
    }

    #container {
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    #sidebar {
      width: 320px;
      min-width: 200px;
      max-width: 500px;
      background: #ffffff;
      border-right: 1px solid #ddd;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      resize: horizontal;
      transition: width 0.3s ease;
    }

    #toggleSidebar {
      position: absolute;
      top: 10px;
      left: 320px;
      width: 30px;
      height: 30px;
      background-color: #ccc;
      border-radius: 5px;
      border: none;
      cursor: pointer;
      z-index: 1001;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: left 0.3s ease;
    }

    #toggleSidebar span {
      font-size: 16px;
      font-weight: bold;
      color: black;
    }

    #map {
      flex-grow: 1;
      transition: margin-left 0.3s ease;
    }

    .collapsed #sidebar {
      width: 0;
    }

    .collapsed #toggleSidebar {
      left: 10px;
    }

    h1 {
      font-size: 1.8rem;
      color: #2c3e50;
      margin: 10px 15px 5px;
    }

    .slogan {
      font-size: 0.9rem;
      color: #27ae60;
      font-style: italic;
      margin: 0 15px 15px;
    }

    .section {
      padding: 10px 15px;
      border-bottom: 1px solid #eee;
    }

    .field-list {
      margin-left: 10px;
      font-size: 0.9rem;
      color: #444;
    }

    #fieldModal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border: 2px solid #27ae60;
      padding: 20px;
      border-radius: 10px;
    }

    #fieldModal input {
      width: 100%;
      margin-bottom: 10px;
      padding: 5px;
    }

    #fieldModal select, #fieldModal button {
      padding: 5px;
      width: 100%;
      margin-bottom: 10px;
    }

    .farm-item {
      margin-bottom: 10px;
    }

    .farm-fields {
      margin-left: 10px;
    }
  </style>
</head>
<body>
<div id="container">
  <div id="sidebar">
    <h1>Agri Trace</h1>
    <p class="slogan">Precision meets productivity.</p>
    <div class="section">
      <input id="farmName" placeholder="Farm name" />
      <input id="farmZIP" placeholder="ZIP or Address" />
      <button onclick="addFarm()">Add Farm</button>
    </div>
    <div class="section" id="farmList"></div>
  </div>

  <button id="toggleSidebar" onclick="toggleSidebar()">
    <span>&larr;</span>
  </button>

  <div id="map"></div>
</div>

<div id="fieldModal">
  <h3>Add Field or Orchard Block</h3>
  <input type="text" id="fieldName" placeholder="Name" />
  <input type="text" id="cropType" placeholder="Crops" />
  <button onclick="saveFieldDetails()">Save</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
<script>
  mapboxgl.accessToken = 'pk.eyJ1IjoiYW5nZWxkaWF6NTIiLCJhIjoiY21jYTNobzR6MDIyaDJ5cHQ1enpiZDN3NSJ9.ANupH-_KNxGYFc4efzpFmg';

  const map = L.map('map', {
    zoom: 13,
    center: [47.6062, -122.3321],
    layers: []
  });

  const street = L.tileLayer(`https://api.mapbox.com/styles/v1/mapbox/streets-v11/tiles/{z}/{x}/{y}?access_token=${mapboxgl.accessToken}`, {
    attribution: 'Â© Mapbox',
    tileSize: 512,
    zoomOffset: -1
  });

  const satellite = L.tileLayer(`https://api.mapbox.com/styles/v1/mapbox/satellite-v9/tiles/{z}/{x}/{y}?access_token=${mapboxgl.accessToken}`, {
    tileSize: 512,
    zoomOffset: -1
  });

  const baseMaps = {
    "Satellite": satellite,
    "Streets": street
  };

  L.control.layers(baseMaps).addTo(map);
  satellite.addTo(map);

  const drawnItems = L.featureGroup().addTo(map);
  let drawControl;
  let currentFarm = null;
  let tempLayer = null;

  const farms = JSON.parse(localStorage.getItem("farms")) || {};

  function toggleSidebar() {
    document.body.classList.toggle("collapsed");
    document.querySelector("#toggleSidebar span").innerHTML =
      document.body.classList.contains("collapsed") ? "&rarr;" : "&larr;";
  }

  function updateFarmList() {
    const list = document.getElementById("farmList");
    list.innerHTML = '';
    for (const id in farms) {
      const farm = farms[id];
      const div = document.createElement('div');
      div.className = 'farm-item';
      div.innerHTML = `<strong>${farm.name}</strong>
        <button onclick="centerFarm('${id}')">View</button>
        <div class="farm-fields">${farm.fields.map(f => `<div>${f.name} (${f.crop})</div>`).join('')}</div>`;
      list.appendChild(div);
    }
  }

  async function geocode(address) {
    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${address}`);
    const data = await res.json();
    return data.length ? [parseFloat(data[0].lat), parseFloat(data[0].lon)] : null;
  }

  async function addFarm() {
    const name = document.getElementById("farmName").value;
    const address = document.getElementById("farmZIP").value;
    if (!name || !address) return alert("Enter farm name and address/ZIP.");

    const center = await geocode(address);
    if (!center) return alert("Address not found.");

    const id = `farm-${Date.now()}`;
    farms[id] = { name, center, fields: [] };
    localStorage.setItem("farms", JSON.stringify(farms));
    updateFarmList();
    map.setView(center, 16);
  }

  function centerFarm(id) {
    currentFarm = id;
    map.setView(farms[id].center, 16);
    drawnItems.clearLayers();
    farms[id].fields.forEach(f => {
      const layer = L.geoJSON(f.geometry).addTo(drawnItems);
    });
  }

  function saveFieldDetails() {
    const name = document.getElementById("fieldName").value;
    const crop = document.getElementById("cropType").value;
    if (!name || !crop || !tempLayer || !currentFarm) return;

    const field = {
      name,
      crop,
      geometry: tempLayer.toGeoJSON()
    };

    farms[currentFarm].fields.push(field);
    localStorage.setItem("farms", JSON.stringify(farms));
    document.getElementById("fieldModal").style.display = "none";
    tempLayer.addTo(drawnItems);
    updateFarmList();
  }

  map.on('draw:created', (e) => {
    if (!currentFarm) return alert("Select a farm first.");
    tempLayer = e.layer;
    document.getElementById("fieldModal").style.display = "block";
  });

  drawControl = new L.Control.Draw({
    draw: {
      polygon: true,
      rectangle: true,
      polyline: false,
      marker: false,
      circle: false,
      circlemarker: false
    },
    edit: {
      featureGroup: drawnItems
    }
  });
  map.addControl(drawControl);

  updateFarmList();
</script>
</body>
</html>
